{% extends 'core/base.html' %}
{% block content %}
<div class="max-w-5xl mx-auto px-4 py-8">
    
    <div class="bg-white rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-100 p-8 mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div>
                <div class="flex items-center gap-4 mb-4">
                    <a href="{% url 'admin_dashboard' %}" class="inline-flex items-center text-[10px] text-slate-400 font-black uppercase tracking-widest hover:text-indigo-600 transition-colors">
                        <span class="mr-2">‚Üê</span> Back to Dashboard
                    </a>
                    <a href="{% url 'export_incident_pdf' incident.id %}" class="inline-flex items-center bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest hover:bg-indigo-600 hover:text-white transition-all shadow-sm active:scale-95">
                        <span class="mr-2 text-xs">üì•</span> Download PDF Audit
                    </a>
                </div>
                
                <h2 class="text-3xl font-black text-slate-900 tracking-tighter leading-tight">
                    Audit Transcript: <span class="text-indigo-600">#{{ incident.case_token|default:incident.id }}</span>
                </h2>
                <div class="flex items-center gap-3 mt-2">
                    <span class="px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest
                        {% if incident.status == 'New' %}bg-indigo-100 text-indigo-600
                        {% elif incident.status == 'Under Review' %}bg-amber-100 text-amber-600
                        {% elif incident.status == 'Resolved' %}bg-emerald-100 text-emerald-600
                        {% else %}bg-slate-100 text-slate-500{% endif %}">
                        Status: {{ incident.status }}
                    </span>
                    {% if incident.is_emergency %}
                        <span class="bg-rose-500 text-white text-[9px] font-black px-2 py-1 rounded-md animate-pulse uppercase">Emergency Alert</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="flex flex-col items-end text-right">
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Parties Involved</p>
                <p class="text-sm font-bold text-slate-700">
                    Reporter: <span class="text-indigo-600">{% if incident.is_anonymous and not incident.is_identity_revealed %}Identity Shielded{% else %}{{ incident.reporter.username }}{% endif %}</span>
                </p>
                <p class="text-xs font-medium text-slate-400">Monitoring Mode: Read-Only Audit</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-[3rem] shadow-2xl shadow-slate-200/50 border border-slate-100 overflow-hidden flex flex-col h-[650px]">
        
        <div class="px-8 py-4 bg-slate-900 text-white flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 bg-rose-500 rounded-full"></div>
                <h3 class="font-black text-[10px] uppercase tracking-[0.2em]">Live Compliance Audit Log</h3>
            </div>
            <span class="text-[9px] font-black bg-white/10 px-3 py-1 rounded-full uppercase">Encrypted History</span>
        </div>

        <div id="audit-window" class="flex-1 p-8 overflow-y-auto space-y-6 bg-slate-50/50 no-scrollbar">
            
            <div class="flex justify-center mb-8">
                <div class="max-w-2xl w-full bg-white border border-slate-200 rounded-3xl p-6 shadow-sm">
                    <p class="text-[10px] font-black text-indigo-600 uppercase tracking-widest mb-2 flex items-center gap-2">
                        <span class="text-base">üìÑ</span> Original Incident Statement
                    </p>
                    <p class="text-sm text-slate-600 italic leading-relaxed">"{{ incident.description }}"</p>
                    <div class="mt-4 pt-4 border-t border-slate-50 flex justify-between text-[9px] font-bold text-slate-400 uppercase">
                        <span>Reported via App</span>
                        <span>{{ incident.reported_at|date:"F d, Y P" }}</span>
                    </div>
                </div>
            </div>

            <div class="relative flex items-center justify-center py-4">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                <span class="relative px-4 bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">Discussion Start</span>
            </div>

            {% for msg in messages %}
                <div class="flex {% if msg.sender.role == 'student' %}justify-start{% else %}justify-end{% endif %}">
                    <div class="max-w-[75%] flex flex-col {% if msg.sender.role == 'student' %}items-start{% else %}items-end{% endif %}">
                        <div class="p-4 rounded-3xl text-sm shadow-sm 
                            {% if msg.sender.role == 'student' %}
                                bg-white border border-slate-100 text-slate-800 rounded-tl-none
                            {% else %}
                                bg-slate-900 text-white rounded-tr-none
                            {% endif %}">
                            
                            <div class="flex items-center gap-3 mb-1 opacity-50">
                                <span class="font-black text-[9px] uppercase tracking-widest">
                                    {% if msg.sender.role == 'student' and incident.is_anonymous and not incident.is_identity_revealed %}
                                        Anonymous Student
                                    {% else %}
                                        {{ msg.sender.username }}
                                    {% endif %}
                                </span>
                                <span class="text-[8px] font-bold">{{ msg.created_at|date:"P" }}</span>
                            </div>
                            
                            <p class="font-medium leading-relaxed">{{ msg.text }}</p>
                        </div>
                        
                        <span class="text-[9px] mt-2 font-black uppercase tracking-tighter 
                            {% if msg.sender.role == 'student' %}text-indigo-400{% else %}text-slate-400{% endif %}">
                            {{ msg.sender.role }}
                        </span>
                    </div>
                </div>
            {% empty %}
                <div class="flex flex-col items-center justify-center h-full text-center space-y-4 opacity-30">
                    <span class="text-6xl">üì≠</span>
                    <p class="text-sm font-black uppercase tracking-widest text-slate-900">No communication recorded yet</p>
                </div>
            {% endfor %}
        </div>

        <div class="p-6 bg-amber-50 border-t border-amber-100 text-center">
            <p class="text-[10px] font-bold text-amber-700 uppercase tracking-[0.1em]">
                ‚ö†Ô∏è Warning: As an Administrator, your access to this transcript is logged for compliance and security auditing.
            </p>
        </div>
    </div>
</div>

<script>
    const auditWindow = document.getElementById('audit-window');
    if (auditWindow) {
        auditWindow.scrollTop = auditWindow.scrollHeight;
    }
</script>
{% endblock %}