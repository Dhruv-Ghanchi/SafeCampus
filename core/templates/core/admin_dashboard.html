{% extends 'core/base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 py-10">
    <div class="flex flex-col md:flex-row justify-between items-end mb-10 gap-6">
        <div>
            <h2 class="text-5xl font-black text-slate-900 tracking-tighter">Admin Control</h2>
            <p class="text-slate-500 font-medium text-lg">Institutional Safety Overview & Analytics</p>
        </div>
        <div class="flex gap-4">
            <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm text-center min-w-[120px]">
                <p class="text-[10px] font-black text-slate-400 uppercase">Avg Sentiment</p>
                <p class="text-2xl font-black {% if avg_sentiment < 0 %}text-rose-500{% else %}text-emerald-500{% endif %}">
                    {{ avg_sentiment }}
                </p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="bg-indigo-600 p-8 rounded-[2.5rem] text-white shadow-xl shadow-indigo-100">
            <p class="text-indigo-200 font-black uppercase text-[10px] tracking-widest mb-2">Total Reports</p>
            <h3 class="text-5xl font-black">{{ total_reports }}</h3>
        </div>
        <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
            <p class="text-slate-400 font-black uppercase text-[10px] tracking-widest mb-2">Registered Students</p>
            <h3 class="text-5xl font-black text-slate-900">{{ student_count }}</h3>
        </div>
        <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
            <p class="text-slate-400 font-black uppercase text-[10px] tracking-widest mb-2">Staff Members</p>
            <h3 class="text-5xl font-black text-slate-900">{{ counsellor_count }}</h3>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
        <div class="bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm">
            <h4 class="text-xl font-black text-slate-900 mb-6">Campus Sentiment Mood</h4>
            <div class="h-[300px] flex justify-center">
                <canvas id="sentimentChart"></canvas>
            </div>
        </div>

        <div class="bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm">
            <h4 class="text-xl font-black text-slate-900 mb-6">Case Status Tracking</h4>
            <div class="h-[300px]">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-[3rem] border border-slate-100 shadow-sm overflow-hidden mb-10">
        <div class="p-8 border-b border-slate-50 flex justify-between items-center">
            <h4 class="text-xl font-black text-slate-900">Recent Activity Log</h4>
            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Live Updates</span>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50/50 text-[10px] font-black uppercase text-slate-400 tracking-widest">
                    <tr>
                        <th class="p-6">Case Token</th>
                        <th class="p-6">Reported By</th>
                        <th class="p-6">Status</th>
                        <th class="p-6">Sentiment</th>
                        <th class="p-6 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-50">
                    {% for incident in incidents %}
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="p-6">
                            <span class="font-mono font-black text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg">#{{ incident.case_token }}</span>
                        </td>
                        <td class="p-6">
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-slate-700">
                                    {% if incident.is_anonymous %}Anonymous Student{% else %}{{ incident.reporter.username }}{% endif %}
                                </span>
                                <span class="text-[10px] text-slate-400 font-medium">{{ incident.reported_at|date:"M d, H:i" }}</span>
                            </div>
                        </td>
                        <td class="p-6">
                            <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase 
                                {% if incident.status == 'Under Review' %}bg-amber-100 text-amber-600
                                {% elif incident.status == 'Resolved' %}bg-emerald-100 text-emerald-600
                                {% elif incident.is_emergency %}bg-rose-100 text-rose-600
                                {% else %}bg-slate-100 text-slate-500{% endif %}">
                                {{ incident.status }}
                            </span>
                        </td>
                        <td class="p-6">
                            <div class="flex items-center gap-2">
                                <div class="w-12 bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                    <div class="h-full {% if incident.sentiment_score < 0 %}bg-rose-500{% else %}bg-emerald-500{% endif %}" 
                                         style="width: 50%"></div>
                                </div>
                                <span class="text-xs font-bold {% if incident.sentiment_score < 0 %}text-rose-500{% else %}text-emerald-500{% endif %}">
                                    {{ incident.sentiment_score|floatformat:2 }}
                                </span>
                            </div>
                        </td>
                        <td class="p-6 text-right">
                            <a href="{% url 'admin_view_chat' incident.id %}" class="inline-flex items-center gap-2 bg-slate-900 text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-600 transition-all shadow-lg shadow-slate-200">
                                Monitor Chat
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="p-20 text-center text-slate-400 font-bold">No reports found in the database.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-[3rem] border border-slate-100 shadow-sm overflow-hidden">
            <div class="p-8 border-b border-slate-50 bg-slate-50/30">
                <h4 class="text-xl font-black text-slate-900">Staff Management</h4>
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Counsellors & Security</p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50/50 text-[10px] font-black uppercase text-slate-400">
                        <tr>
                            <th class="p-6">User</th>
                            <th class="p-6">Role</th>
                            <th class="p-6">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        {% for staff in staff_members %}
                        <tr>
                            <td class="p-6 font-bold text-slate-700 text-sm">{{ staff.username }}</td>
                            <td class="p-6">
                                <span class="px-2 py-1 rounded text-[9px] font-black uppercase {% if staff.role == 'counsellor' %}bg-purple-100 text-purple-600{% else %}bg-blue-100 text-blue-600{% endif %}">
                                    {{ staff.role }}
                                </span>
                            </td>
                            <td class="p-6">
                                <div class="flex items-center gap-1.5">
                                    <div class="w-1.5 h-1.5 rounded-full {% if staff.last_login %}bg-emerald-500{% else %}bg-slate-300{% endif %}"></div>
                                    <span class="text-[10px] font-bold text-slate-500">{% if staff.last_login %}Active{% else %}Inactive{% endif %}</span>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="p-10 text-center text-slate-400 text-xs">No staff found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-[3rem] border border-slate-100 shadow-sm overflow-hidden">
            <div class="p-8 border-b border-slate-50 bg-slate-50/30">
                <h4 class="text-xl font-black text-slate-900">Student Directory</h4>
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Registered App Users</p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50/50 text-[10px] font-black uppercase text-slate-400">
                        <tr>
                            <th class="p-6">Student Name</th>
                            <th class="p-6">Joined Date</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        {% for student in students %}
                        <tr>
                            <td class="p-6 font-bold text-slate-700 text-sm">{{ student.username }}</td>
                            <td class="p-6 text-[10px] text-slate-400 font-bold uppercase">{{ student.date_joined|date:"M d, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="2" class="p-10 text-center text-slate-400 text-xs">No students registered.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // 1. Sentiment Chart
    const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
    new Chart(sentimentCtx, {
        type: 'doughnut',
        data: {
            labels: ['Negative', 'Neutral/Positive'],
            datasets: [{
                data: [{{ total_reports }}, 2],
                backgroundColor: ['#f43f5e', '#10b981'],
                borderWidth: 0
            }]
        },
        options: { cutout: '80%', plugins: { legend: { position: 'bottom' } } }
    });

    // 2. Status Bar Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'bar',
        data: {
            labels: ['New', 'Review', 'Action', 'Resolved'],
            datasets: [{
                label: 'Cases',
                data: [{{ total_reports }}, 2, 1, 3], 
                backgroundColor: '#6366f1',
                borderRadius: 10
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } },
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}